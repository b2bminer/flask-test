<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@latest/plotly.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles_portfolio.css') }}">
</head>
<body class="bg-dark text-light">
    <div class="container-fluid mt-4 px-md-3 px-2">
        <div class="card" id="analyzestock">
            <div class="card-body">
                <div class="mb-3">
                    <label for="inputText" class="form-label">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</label>
                    <textarea id="inputText" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏´‡∏∏‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô AOT RSI ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 75..."></textarea>
                </div>
                <button class="btn btn-primary" id="summarizeBtn" onclick="analyze()">‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß</button>
                <button class="btn btn-primary" id="analyzeBtn">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏∏‡πâ‡∏ô SET100</button>
                <button class="btn btn-primary" id="analyzeWatchlistBtn">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏∏‡πâ‡∏ô Watchlist"</button>
                <button class="btn btn-primary" id="deleteAllWatchlistBtn">‡∏•‡∏ö Watchlist"</button>
                <div id="loadingIndicator" class="text-center my-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô...</p>
                </div>
                <div id="result" class="mt-3 alert" style="display: none;">
                    <p id="summary"></p>
                    <img id="chart" src="" style="max-width:100%;" />
                    <img id="chart2" src="" style="max-width:100%;" />
                    <img id="chart3" src="" style="max-width:100%;" />
                    <img id="chart4" src="" style="max-width:100%;" />
                    <img id="chart5" src="" style="max-width:100%;" />
                    <img id="chart6" src="" style="max-width:100%;" />
                    <img id="chart7" src="" style="max-width:100%;" />
                </div>
                <div id="analysisSection" class="hidden-section">
                    <div class="row mb-3 mt-4">
                        <div class="col">
                            <label for="zoneFilter">‡πÇ‡∏ã‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤:</label>
                            <select id="zoneFilter" class="form-select">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏ñ‡∏π‡∏Å (Undervalued)">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏ñ‡∏π‡∏Å (Undervalued)</option>
                                <option value="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡πÅ‡∏û‡∏á (Overvalued)">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡πÅ‡∏û‡∏á (Overvalued)</option>
                                <option value="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (Fair Value)">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (Fair Value)</option>
                            </select>
                        </div>
                        <div class="col">
                            <label for="volumeFilter">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢:</label>
                            <select id="volumeFilter" class="form-select">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô</option>
                                <option value="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏•‡∏î‡∏•‡∏á">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏•‡∏î‡∏•‡∏á</option>
                                <option value="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏õ‡∏Å‡∏ï‡∏¥</option>
                            </select>
                        </div>
                        <div class="col">
                            <label for="trendFilter">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°:</label>
                            <select id="trendFilter" class="form-select">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô (Bullish)">‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô (Bullish)</option>
                                <option value="‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô">‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô</option>
                                <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</option>
                            </select>
                        </div>
                        <div class="col">
                            <label for="signalFilter">Signal:</label>
                            <select id="signalFilter" class="form-select">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="Buy">Buy</option>
                                <option value="Sell">Sell</option>
                                <option value="-">-</option>
                            </select>
                        </div>
                        <div class="col">
                            <label for="rsistatusFilter">RSI+Pattern:</label>
                            <select id="rsistatusFilter" class="form-select">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="Overbought">Overbought</option>
                                <option value="Oversold">Oversold</option>
                                <option value="Bullish">Bullish</option>
                                <option value="Bearish">Bearish</option>
                                <option value="Double Bottom">Double Bottom</option>
                                <option value="-">-</option>
                            </select>
                        </div>
                        <div class="col">
                            <label for="rsiFilter">RSI Predicted:</label>
                            <select id="rsiFilter" class="form-select">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="üü¢ RSI ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å‡πÄ‡∏Ç‡∏ï Oversold">üü¢ RSI ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å‡πÄ‡∏Ç‡∏ï Oversold</option>
                                <option value="üî¥ RSI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å Overbought">üî¥ RSI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å Overbought</option>
                                <option value="‚ö™ RSI ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á">‚ö™ RSI ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                            </select>
                        </div>
                        <div class="col">
                            <label for="candleFilter">‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß:</label>
                            <select id="candleFilter" class="form-select">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="has">‡∏°‡∏µ</option>
                                <option value="none">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                            </select>
                        </div>
                        <div class="col">
                            <label for="closechangeFilter">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:</label>
                            <select id="closechangeFilter" class="form-select">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="up">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô</option>
                                <option value="down">‡∏•‡∏î‡∏•‡∏á</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="stockTableContainer" class="table-responsive" style="max-width: 100%; max-height: 400px; overflow: auto;">
                    <table id="stockTable" class="table table-striped table-dark table-hover table-bordered border-secondary">
                        <thead>
                            <tr>
                                <th>1d</th>
                                <th>1h</th>
                                <th>15m</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</th>
                                <th>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</th>
                                <th>% ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</th>
                                <th>‡πÇ‡∏ã‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                <th>‡πÄ‡∏ó‡∏£‡πá‡∏ô‡∏î‡πå‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</th>
                                <th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</th>
                                <th>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</th>
                                <th>‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß</th>
                                <th>Signal</th>
                                <th>RSI+Pattern</th>
                                <th>RSI Predicted</th>
                                <th>Actions</th>
                                <th>Download Data</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
                        </tbody>
                    </table>
                </div>
                <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á quote_data -->
                <div class="modal fade" id="quoteModal" tabindex="-1" aria-labelledby="quoteModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="quoteModalLabel">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô <span id="modalTicker"></span></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="quoteModalBody">
                                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-briefcase me-2"></i>Watchlist
                </h5>
                <button id="refreshWatchlistBtn" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-arrow-clockwise"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>
            </div>
            <div id="WatchlistLoader" class="text-center my-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Watch List...</p>
            </div>
            <div class="table-responsive" style="max-width: 100%; max-height: 400px; overflow: auto;">
                <table class="table table-hover table-dark table-bordered border-secondary" id="watchlistTable">
                    <thead class="table-dark">
                        <tr>
                            <th>1d</th>
                            <th>1h</th>
                            <th>15m</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô</th>
                            <th class="text-end">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î</th>
                            <th class="text-end">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</th>
                            <th class="text-end">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</th>
                            <th class="text-end">% ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</th>
                            <th class="text-end">‡πÇ‡∏ã‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                            <th class="text-end">‡πÄ‡∏ó‡∏£‡πá‡∏ô‡∏î‡πå‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</th>
                            <th class="text-end">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</th>
                            <th class="text-end">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</th>
                            <th class="text-end">‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß</th>
                            <th class="text-end">Signal</th>
                            <th class="text-end">RSI+Pattern</th>
                            <th class="text-end">RSI Predicted</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody id="watchlistBody">
                        <!-- Watchlist rows will be injected here -->
                    </tbody>
                </table>
            </div>
            <div class="container">
                <div class="stock-selector">
                    <div class="stock-list" id="set100StockList">
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="stock-selector">
                <div class="stock-list" id="watchlistStockList">
                    <div class="stock-item active" data-symbol="NASDAQ:AAPL">Apple (AAPL)</div>
                    <div class="stock-item" data-symbol="NASDAQ:MSFT">Microsoft (MSFT)</div>
                    <div class="stock-item" data-symbol="NASDAQ:GOOGL">Google (GOOGL)</div>
                    <div class="stock-item" data-symbol="NASDAQ:AMZN">Amazon (AMZN)</div>
                    <div class="stock-item" data-symbol="NASDAQ:META">Meta (META)</div>
                    <div class="stock-item" data-symbol="NASDAQ:TSLA">Tesla (TSLA)</div>
                    <div class="stock-item" data-symbol="NYSE:JPM">JPMorgan (JPM)</div>
                    <div class="stock-item" data-symbol="NYSE:V">Visa (V)</div>
                    <div class="stock-item" data-symbol="FOREXCOM:XAUUSD">XAUUSD</div>
                    <div class="stock-item" data-symbol="FOREXCOM:USDTHB">USDTHB</div>
                </div>
            </div>
            <div class="chart-container">
                <div id="tradingview_chart"></div>
            </div>
            <div class="info">
                <p>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢ TradingView | ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="current-date"></span></p>
            </div>
        </div>

        {% if account_info %}
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-wallet2"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 1 -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</h6>
                                <p class="fs-4 text-primary">
                                    {{ "{:,.2f}".format(account_info.creditLimit) }} ‡∏ø
                                </p>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-muted">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</h6>
                                <p class="fs-4 text-success">
                                    {{ "{:,.2f}".format(account_info.lineAvailable) }} ‡∏ø
                                </p>
                            </div>
                        </div>
                        
                        <!-- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 2 -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h6>
                                <p class="fs-4 text-info">
                                    {{ "{:,.2f}".format(account_info.cashBalance) }} ‡∏ø
                                </p>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h6>
                                <p>
                                    <span class="badge bg-{{ 'success' if account_info.canBuy else 'secondary' }}">‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ</span>
                                    <span class="badge bg-{{ 'success' if account_info.canSell else 'secondary' }}">‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
                    <div class="mt-3 pt-3 border-top">
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</small>
                                <p>{{ account_info.accountType }}</p>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</small>
                                <p>{{ account_info.clientType }}</p>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</small>
                                <p>{{ account_info.crossingKey }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid mt-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-briefcase me-2"></i>‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏ü‡∏•‡∏¥‡πÇ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                        </h5>
                        <button id="refreshPortfolioBtn" class="btn btn-sm btn-outline-light">
                            <i class="bi bi-arrow-clockwise"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                    </div>
                    
                    <div class="card-body bg-dark text-light">
                        <div id="portfolioSummary" class="row mb-4 bg-dark">
                            <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                        </div>                
                        <div class="table-responsive">
                            <table class="table table-dark table-hover table-bordered border-secondary">
                                <thead>
                                    <tr>
                                    <th>‡∏´‡∏∏‡πâ‡∏ô</th>
                                    <th class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th class="text-end">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                                    <th class="text-end">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                                    <th class="text-end">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏•‡∏≤‡∏î</th>
                                    <th class="text-end">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</th>
                                    </tr>
                                </thead>
                                <tbody id="portfolioTableBody" class="text-light">
                                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <p>{{quote_data}}</p>
        {% endif %}

        <!-- Modal Zoom Graph-->
        <div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen modal-dialog-centered" style="margin-top: 5vh; margin-bottom: 5vh;">
                <div class="modal-content h-100">
                    <div class="modal-header">
                        <h5 class="modal-title" id="chartModalLabel">‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏ô‡∏≤‡∏î</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="modal-img-container">
                            <img id="modalImage" src="" alt="‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏ô‡∏≤‡∏î" class="modal-img">
                            <div class="help-text" id="helpText">‡πÉ‡∏ä‡πâ Scroll ‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å ‚Ä¢ ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</div>
                            <div class="modal-controls-group">
                                <div class="zoom-controls">
                                    <button type="button" class="zoom-btn" id="zoomInBtn" title="‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤">
                                        <i class="fas fa-search-plus fa-icon-fix"></i>
                                    </button>
                                    <button type="button" class="zoom-btn" id="zoomOutBtn" title="‡∏ã‡∏π‡∏°‡∏≠‡∏≠‡∏Å">
                                        <i class="fas fa-search-minus fa-icon-fix"></i>
                                    </button>
                                    <button type="button" class="zoom-btn" id="resetZoomBtn" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°">
                                        <i class="fas fa-sync-alt fa-icon-fix"></i>
                                    </button>
                                </div>
                                <div class="action-controls">
                                    <button type="button" class="action-btn btn-download-modal" id="downloadBtn" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü">
                                        <i class="fas fa-download fa-icon-fix"></i>
                                    </button>
                                    <button type="button" class="action-btn btn-close-modal" id="closeModalBtn" title="‡∏õ‡∏¥‡∏î" data-bs-dismiss="modal">
                                        <i class="fas fa-times fa-icon-fix"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="mt-3">
            <a href="/downloadStockdata?load_flag=WL" class="btn btn-outline-secondary me-2">Download Stock Data (Watchlist)</a>
            <a href="/downloadStockdata?load_flag=SET100A" class="btn btn-outline-secondary me-2">Download Stock Data (Set100 #A)</a>
            <a href="/downloadStockdata?load_flag=SET100B" class="btn btn-outline-secondary me-2">... (Set100 #B)</a>
            <a href="/downloadStockdata?load_flag=SET100C" class="btn btn-outline-secondary me-2">... (Set100 #C)</a>
        </div>
    </div>

    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11"></div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>

    document.addEventListener("DOMContentLoaded", function () {

        document.getElementById('analyzeBtn').addEventListener('click', () => analyzeAllStocks("all"));
        document.getElementById('analyzeWatchlistBtn').addEventListener('click', () => analyzeAllStocks("watchlist"));
        document.getElementById('deleteAllWatchlistBtn').addEventListener('click', deleteAllWatchList);
        document.getElementById('refreshWatchlistBtn').addEventListener('click', loadWatchlist);

        const analysisSection = document.getElementById('analysisSection');
        const loadingIndicator = document.getElementById('loadingIndicator');

        //const portfolioData = getPortfolioData();
        //renderPortfolio(portfolioData);
        loadWatchlist();
        displaySet100StockList();
    });

    async function analyzeAllStocks(mode) {
        try {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
            showLoading(true, 'StockAnalysis');
            showResult('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', 'success');
            
            let bodyData = {};
            if (mode === "all") {
                bodyData = { analyze_all: true };
            } else if (mode === "watchlist") {
                bodyData = { analyze_watchlist: true };
            }
            const response = await fetch('/summarize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyData)
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                analysisSection.classList.remove('hidden-section');
                document.getElementById('stockTableContainer').style.display = 'block';
                updateStockTable(data.all_results);
                showResult('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                if (mode === "watchlist") {
                    displayWatchlistSet100List(data.all_results);
                }
            } else {
                showResult('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message, 'danger');
            }
        } catch (error) {
            showResult('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'danger');
            console.error('Request failed:', error);
        } finally {
            showLoading(false, 'StockAnalysis');
        }
    }

    function displayWatchlistSet100List(allResults) {
        const stockListContainer = document.getElementById("watchlistStockList");
        //stockListContainer.innerHTML = '';
        const defaultSymbols = [
            { ticker: "SET" }
        ];
        // ‡∏£‡∏ß‡∏° default ‡∏Å‡∏±‡∏ö allResults
        const combinedList = [...defaultSymbols, ...allResults];
        combinedList.forEach((item, index) => {
            const ticker = String(item.ticker || '').toUpperCase().trim();
            const stockItem = document.createElement('div');
            stockItem.className = `stock-item ${index === 0 ? 'active' : ''}`;
            stockItem.setAttribute('data-symbol', `SET:${ticker}`);
            stockItem.textContent = ticker;
            stockItem.addEventListener('click', () => {
                document.querySelectorAll('.stock-item').forEach(el => el.classList.remove('active'));
                stockItem.classList.add('active');
                loadTradingViewChart(stockItem.dataset.symbol);
            });
            //stockListContainer.appendChild(stockItem); ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô Watchlist
        });
        // --- ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô SET100 ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Watchlist ---
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Set ‡∏Ç‡∏≠‡∏á watchlist tickers ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
        const watchlistSet = new Set(combinedList.map(i => String(i.ticker || '').toUpperCase().trim()));

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ ticker ‡πÉ‡∏ô set100Tickers ‡πÉ‡∏´‡πâ‡∏´‡∏≤ element ‡πÉ‡∏ô DOM ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ in-watchlist
        set100Tickers.forEach(ticker => {
            if (watchlistSet.has(ticker)) {
                // ‡∏´‡∏≤ element ‡πÉ‡∏ô #set100StockList ‡∏ó‡∏µ‡πà‡∏°‡∏µ data-symbol = SET:<TICKER>
                const selector = `#set100StockList [data-symbol="SET:${ticker}"]`;
                const el = document.querySelector(selector);
                if (el) {
                    el.classList.add('in-watchlist');
                }
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô watchlist ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                const selector = `#set100StockList [data-symbol="SET:${ticker}"]`;
                const el = document.querySelector(selector);
                if (el) el.classList.remove('in-watchlist');
            }
        });

    }

    function loadTradingViewChart(symbol) {
        if (!symbol) {
            console.error("‚ùå Symbol is missing.");
            return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ prefix ‡πÄ‡∏ä‡πà‡∏ô SET:, NASDAQ:, NYSE:
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏•‡∏≤‡∏î SET ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        let fullSymbol = symbol.includes(":") ? symbol : `SET:${symbol}`;

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ symbol ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö URL ‡∏Ç‡∏≠‡∏á TradingView
        const encodedSymbol = encodeURIComponent(fullSymbol);

        // ‡πÄ‡∏õ‡∏¥‡∏î TradingView ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        const tradingViewUrl = `https://www.tradingview.com/chart/?symbol=${encodedSymbol}`;
        window.open(tradingViewUrl, '_blank');

    }

    let set100Tickers = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ SET100 (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà)

    async function displaySet100StockList() {
        try {
            const stockListContainer = document.getElementById("set100StockList");
            stockListContainer.innerHTML = '';

            const response = await fetch('/get_set100', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
            });
            const data = await response.json();
            if (!Array.isArray(data)) {
                showResult('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'danger');
                return;
            }
            set100Tickers = data.map(t => String(t).toUpperCase().trim());
            const extraStocks = [
                { symbol: 'USDZ2025', market: 'TFEX' }
            ];
            const stockList = [
                { symbol: 'SET', market: 'SET' },
                ...extraStocks,
                ...data.map(t => ({ symbol: t, market: 'SET' }))
            ];
            stockList.forEach((item, index) => {
                const normalized = item.symbol.toUpperCase().trim();
                const stockItem = document.createElement('div');
                stockItem.className = `stock-item ${index === 0 ? 'active' : ''}`;
                stockItem.setAttribute('data-symbol', `${item.market}:${normalized}`);
                stockItem.textContent = normalized;

                stockItem.addEventListener('click', () => {
                    document.querySelectorAll('.stock-item').forEach(el => el.classList.remove('active'));
                    stockItem.classList.add('active');
                    loadTradingViewChart(stockItem.dataset.symbol);
                });
                stockListContainer.appendChild(stockItem);
            });
        } catch (error) {
            showResult('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'danger');
            console.error('Request failed:', error);
        } finally {
            showLoading(false, 'StockAnalysis');
        }
    }

    function showLoading(isLoading, type) {
        //const loader = document.getElementById('loadingIndicator');
        //const table = document.getElementById('stockTable');
        let loader, content, result;        
        if (type === 'StockAnalysis') {
            loader = document.getElementById('loadingIndicator');
            table = document.getElementById('stockTable');
            //result = document.getElementById('stockAnalysisResult');
        } else if (type === 'Watchlist') {
            loader = document.getElementById('WatchlistLoader');
            table = document.getElementById('watchlistTable');
            //result = document.getElementById('watchlistResult');
        } else {
            console.error('Unknown loading type:', type);
            return;
        }
        if (isLoading) {
            loader.style.display = 'block';
            table.style.display = 'none';
        } else {
            loader.style.display = 'none';
            table.style.display = 'table';
        }
    }

    function showResult(message, type) {
        const summaryP = document.getElementById('summary');
        const resultDiv = document.getElementById('result');

        summaryP.textContent = message;
        resultDiv.className = `alert alert-${type}`;
        resultDiv.style.display = 'block';
    }

    function updateStockTable(allResults) {
        try {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• allResults
            const tableBody = document.getElementById('stockTableBody');
            tableBody.innerHTML = '';
            
            allResults.forEach((result, index) => {
                const isInWatchlist = result.is_in_watchlist || false;
                const row = document.createElement('tr');

                row.setAttribute('data-zone', result.price_zone?.zone_analysis || '');
                row.setAttribute('data-volume', result.volume_analysis?.volume_signal || '');
                row.setAttribute('data-trend', result.analysis || '');
                row.setAttribute('data-signal', result.signal || '');
                row.setAttribute('data-rsistatus', result.rsi_status || '');
                row.setAttribute('data-rsi', result.rsi_signal || '');
                row.setAttribute('data-candle', result.candle_pattern || '');
                row.setAttribute('data-closechange', 
                    result.latest_close && result.previous_close ? 
                    (result.latest_close > result.previous_close ? 'up' : 'down') : '');

                const previousClose = result.previous_close ? result.previous_close.toFixed(2) : '-';
                const priceChangeAbs = result.price_change && result.price_change.absolute 
                    ? result.price_change.absolute.toFixed(2) 
                    : '-';
                const priceChangePercent = result.price_change && result.price_change.percent 
                    ? result.price_change.percent.toFixed(2) + '%' 
                    : '-';
                const priceZone = result.price_zone && result.price_zone.zone_analysis 
                    ? result.price_zone.zone_analysis 
                    : '-';
                const volumeSignal = result.volume_analysis && result.volume_analysis.volume_signal 
                    ? result.volume_analysis.volume_signal 
                    : '-';

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• result
                row.innerHTML = `
                    <td class="text-end">
                        <img id="chart777-${index}" 
                            src="data:image/png;base64,${result.chart77}" 
                            alt="Chart" 
                            class="chart-img"
                            data-bs-toggle="modal" 
                            data-bs-target="#chartModal"
                            style="width: 250px; height:auto; cursor:zoom-in;">
                    </td>
                    <td class="text-end">
                        <img id="chart778-${index}" 
                            src="data:image/png;base64,${result.chart78}" 
                            alt="Chart" 
                            class="chart-img"
                            data-bs-toggle="modal" 
                            data-bs-target="#chartModal"
                            style="width: 250px; height:auto; cursor:zoom-in;">
                    </td>
                    <td class="text-end">
                        <img id="chart779-${index}" 
                            src="data:image/png;base64,${result.chart79}" 
                            alt="Chart" 
                            class="chart-img"
                            data-bs-toggle="modal" 
                            data-bs-target="#chartModal"
                            style="width: 250px; height:auto; cursor:zoom-in;">
                    </td>
                    <td>
                        <a href="/stock_analyze2/${encodeURIComponent(result.ticker)}" class="ticker-link" target="_blank">
                            ${result.ticker || '-'}
                        </a>
                    </td>
                    <td class="text-end">${result.latest_close || '-'}</td>
                    <td class="text-end">${previousClose}</td>
                    <td class="text-end">${priceChangeAbs}</td>
                    <td class="text-end">${priceChangePercent}</td>
                    <td>${priceZone}</td>
                    <td>${result.trendHighPrice_analysis}</td>
                    <td>${volumeSignal}</td>
                    <td>${result.analysis || '-'}</td>
                    <td>${result.candle_pattern || '-'}</td>
                    <td>${result.signal || '-'}</td>
                    <td>${result.rsi_status || '-'}</td>
                    <td>${result.rsi_signal || '-'}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary view-quote" 
                                data-ticker="${result.ticker}"
                                data-prev-close="${result.previous_close || ''}"
                                data-price-open="${result.open || ''}"
                                title="‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤">
                        <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm ${isInWatchlist ? 'btn-outline-secondary' : 'btn-outline-success'} add-watchlist" 
                                data-ticker="${result.ticker}"
                                ${isInWatchlist ? 'disabled' : ''}>
                            <i class="bi ${isInWatchlist ? 'bi-check' : 'bi-plus-circle'}"></i>
                        </button>
                    </td>
                    <td>
                        <a href="/downloadStockdata?ticker=${result.ticker}" class="download-link">
                            <i class="bi bi-download"></i>
                        </a>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            setupFilterHandlers();

            document.querySelectorAll('.view-quote').forEach(btn => {
                btn.addEventListener('click', function() {
                const ticker = this.getAttribute('data-ticker');
                const prevClose = this.getAttribute('data-prev-close');
                const priceOpen = this.getAttribute('data-price-open');
                showQuoteData(ticker, prevClose, priceOpen);
                });
            });
            document.querySelectorAll('.add-watchlist').forEach(btn => {
                btn.addEventListener('click', async function() {
                const ticker = this.getAttribute('data-ticker');
                await addToWatchList(ticker, this);
                });
            });
        } catch (error) {
            console.error('Error updating table:', error);
            const tableBody = document.getElementById('stockTableBody');
            tableBody.innerHTML = `
            <tr>
                <td colspan="13" class="text-center text-danger">
                ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Watch List
                </td>
            </tr>
            `;
        }
    }

    function setupFilterHandlers() {
        const filters = ['zone', 'volume', 'trend', 'candle', 'closechange', 'rsi', 'rsistatus','signal'];
        
        filters.forEach(filter => {
            document.getElementById(`${filter}Filter`).addEventListener('change', filterTable);
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function filterTable() {
        const zoneValue = document.getElementById('zoneFilter').value;
        const volumeValue = document.getElementById('volumeFilter').value;
        const trendValue = document.getElementById('trendFilter').value;
        const signalValue = document.getElementById('signalFilter').value;
        const rsistatusValue = document.getElementById('rsistatusFilter').value;
        const rsiValue = document.getElementById('rsiFilter').value;
        const candleValue = document.getElementById('candleFilter').value;
        const closechangeValue = document.getElementById('closechangeFilter').value;

        document.querySelectorAll('#stockTableBody tr').forEach(row => {
            const zone = row.getAttribute('data-zone');
            const volume = row.getAttribute('data-volume');
            const trend = row.getAttribute('data-trend');
            const signal = row.getAttribute('data-signal');
            const rsistatus = row.getAttribute('data-rsistatus');
            const rsi = row.getAttribute('data-rsi');
            const candle = row.getAttribute('data-candle');
            const closechange = row.getAttribute('data-closechange');

            const zoneMatch = !zoneValue || zone === zoneValue;
            const volumeMatch = !volumeValue || volume === volumeValue;
            const trendMatch = !trendValue || trend === trendValue;
            const signalMatch = !signalValue || signal === signalValue;
            const rsistatusMatch = !rsistatusValue || rsistatus === rsistatusValue;
            const rsiMatch = !rsiValue || rsi === rsiValue;
            const candleMatch = !candleValue || 
                               (candleValue === 'has' && candle) || 
                               (candleValue === 'none' && !candle);
            const closechangeMatch = !closechangeValue || closechange === closechangeValue;

            row.style.display = (zoneMatch && volumeMatch && trendMatch && signalMatch && rsistatusMatch && rsiMatch && 
                               candleMatch && closechangeMatch) ? '' : 'none';
        });
    }

    async function summarize() {
        const input = document.getElementById("inputText").value;
        showResult('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', 'success');

        try {
            const response = await fetch("/summarize", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ text: input })
            });

            const data = await response.json();
            if (data.status === 'success') {
                showResult('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ' + data.summary, 'success');
            } else {
                showResult('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.status, 'danger');
            }

        } catch (error) {
            showResult('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'danger');
            console.error('Request failed:', error);
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Python ‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÉ‡∏ô template
    function getPortfolioData() {
        try {
            // ‡πÉ‡∏ä‡πâ Flask template ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á JavaScript
            return {
            portfolioList: {{ portfolio_data.portfolioList|default([])|tojson|safe }},
            totalPortfolio: {{ portfolio_data.totalPortfolio|default({"marketValue":0,"profit":0,"percentProfit":0})|tojson|safe }}
            };
        } catch (error) {
            console.error('Error parsing portfolio data:', error);
            return {
            portfolioList: [],
            totalPortfolio: {
                marketValue: 0,
                profit: 0,
                percentProfit: 0
            }
            };
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '-';
        return num.toLocaleString('th-TH', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏ü‡∏•‡∏¥‡πÇ‡∏≠
    function renderPortfolio(data) {
        const summaryContainer = document.getElementById('portfolioSummary');
        const tableBody = document.getElementById('portfolioTableBody');
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ
        summaryContainer.innerHTML = `
            <div class="col-md-4 mb-3">
            <div class="card h-100 border-0 bg-light">
                <div class="card-body text-center py-3">
                <h6 class="text-muted mb-2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏ü‡∏•‡∏¥‡πÇ‡∏≠</h6>
                <h4 class="text-primary mb-0">${formatNumber(data.totalPortfolio.marketValue)} ‡∏ø</h4>
                </div>
            </div>
            </div>
            <div class="col-md-4 mb-3">
            <div class="card h-100 border-0 bg-light">
                <div class="card-body text-center py-3">
                <h6 class="text-muted mb-2">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</h6>
                <h4 class="${data.totalPortfolio.profit >= 0 ? 'text-success' : 'text-danger'} mb-0">
                    ${formatNumber(data.totalPortfolio.profit)} ‡∏ø
                </h4>
                </div>
            </div>
            </div>
            <div class="col-md-4 mb-3">
            <div class="card h-100 border-0 bg-light">
                <div class="card-body text-center py-3">
                <h6 class="text-muted mb-2">% ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</h6>
                <h4 class="${data.totalPortfolio.percentProfit >= 0 ? 'text-success' : 'text-danger'} mb-0">
                    ${formatNumber(data.totalPortfolio.percentProfit)}%
                </h4>
                </div>
            </div>
            </div>
        `;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏∏‡πâ‡∏ô
        if (data.portfolioList.length === 0) {
            tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-5">
                <div class="text-muted">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏ü‡∏•‡∏¥‡πÇ‡∏≠</p>
                </div>
                </td>
            </tr>
            `;
        } else {
            tableBody.innerHTML = '';
            data.portfolioList.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                <a href="/stock_analyze2?ticker=${item.symbol}" class="text-decoration-none fw-bold">
                    ${item.symbol}
                </a>
                </td>
                <td class="text-end">${formatNumber(item.amount)}</td>
                <td class="text-end">${formatNumber(item.averagePrice)}</td>
                <td class="text-end">${formatNumber(item.marketPrice)}</td>
                <td class="text-end">${formatNumber(item.marketValue)}</td>
                <td class="text-end ${item.profit >= 0 ? 'text-success' : 'text-danger'}">
                ${formatNumber(item.profit)} ‡∏ø (${formatNumber(item.percentProfit)}%)
                </td>
            `;
            tableBody.appendChild(row);
            });
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• quote_data ‡πÉ‡∏ô Modal
    async function showQuoteData(ticker, prevClose, priceOpen) {
        try {
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Modal
            document.getElementById('modalTicker').textContent = ticker;
            const modalBody = document.getElementById('quoteModalBody');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div></div>';
            
            // ‡πÅ‡∏™‡∏î‡∏á Modal
            const modal = new bootstrap.Modal(document.getElementById('quoteModal'));
            modal.show();
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• quote_data ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
            const response = await fetch(`/get_quote?ticker=${ticker}`);
            const quoteData = await response.json();

            const formatValue = (value, isNumber = true) => {
            if (value === '-' || value === null || value === undefined) return '-';
            if (!isNumber) return value;
            return typeof value === 'number' ? value.toFixed(2) : parseFloat(value).toFixed(2);
            };
            const formattedPrevClose = formatValue(prevClose);
            const formattedpriceOpen = formatValue(priceOpen);

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Modal
            modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                <div class="mb-3">
                    <h6>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                    <p class="fs-4">${quoteData.last?.toFixed(2) || '-'} ‡∏ø</p>
                </div>
                <div class="mb-3">
                    <h6>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</h6>
                    <p class="fs-4 ${quoteData.change >= 0 ? 'text-success' : 'text-danger'}">
                    ${quoteData.change?.toFixed(2) || '-'} ‡∏ø (${quoteData.percentChange?.toFixed(2) || '-'}%)
                    </p>
                </div>
                </div>
                <div class="col-md-6">
                <div class="mb-3">
                    <h6>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
                    <p>${quoteData.high?.toFixed(2) || '-'} ‡∏ø</p>
                </div>
                <div class="mb-3">
                    <h6>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
                    <p>${quoteData.low?.toFixed(2) || '-'} ‡∏ø</p>
                </div>
                <div class="mb-3">
                    <h6>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</h6>
                    <p>${quoteData.volume?.toLocaleString() || '-'} ‡∏´‡∏∏‡πâ‡∏ô</p>
                </div>
                </div>
            </div>
            <div class="mt-3">
                <h6>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h6>
                <div class="table-responsive">
                <table class="table table-sm">
                    <tr>
                    <td>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î</td>
                    <td>${formattedpriceOpen} ‡∏ø</td>
                    <td>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</td>
                    <td>${formattedPrevClose} ‡∏ø</td>
                    <td>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</td>
                    <td>${quoteData.time || '-'}</td>
                    </tr>
                </table>
                </div>
            </div>
            `;
            
        } catch (error) {
            console.error('Error fetching quote data:', error);
            modalBody.innerHTML = '<div class="alert alert-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>';
        }
    }

    async function addToWatchList(ticker, buttonElement) {
        try {
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
            buttonElement.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            buttonElement.disabled = true;
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Watch List
            const response = await fetch('/api/watchlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ticker: ticker })
            });
            
            const result = await response.json();
            
            if (response.ok) {
            // ‡πÅ‡∏™‡∏î‡∏á Toast ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            showToast('success', `‡πÄ‡∏û‡∏¥‡πà‡∏° ${ticker} ‡πÉ‡∏ô Watch List ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å
            buttonElement.innerHTML = '<i class="bi bi-check"></i>';
            buttonElement.classList.remove('btn-outline-success');
            buttonElement.classList.add('btn-outline-secondary');
            } else {
            throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Watch List');
            }
        } catch (error) {
            console.error('Error adding to watchlist:', error);
            showToast('danger', error.message);
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥
            buttonElement.innerHTML = '<i class="bi bi-plus-circle"></i>';
            buttonElement.disabled = false;
        }
    }

    function showToast(type, message) {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();
        
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();
        
        // ‡∏•‡∏ö Toast ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
        document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }

    async function loadWatchlist() {
        try {
            showLoading(true, 'Watchlist');

            const response = await fetch("/render_watchlist");
            const data = await response.json();

            const tableBody = document.getElementById("watchlistBody");
            tableBody.innerHTML = '';

                data.all_results.forEach((item, index) => {
                    const previousClose = item.previous_close ? item.previous_close.toFixed(2) : '-';
                    const priceChangeAbs = item.price_change && item.price_change.absolute 
                    ? item.price_change.absolute.toFixed(2) 
                    : '-';
                    const priceChangePercent = item.price_change && item.price_change.percent 
                    ? item.price_change.percent.toFixed(2) + '%' 
                    : '-';
                    const priceZone = item.price_zone && item.price_zone.zone_analysis 
                        ? item.price_zone.zone_analysis 
                        : '-';
                    const volumeSignal = item.volume_analysis && item.volume_analysis.volume_signal 
                        ? item.volume_analysis.volume_signal 
                        : '-';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-end">
                            <img id="chart77-${index}" 
                                src="data:image/png;base64,${item.chart77}" 
                                alt="Chart" 
                                class="chart-img"
                                data-bs-toggle="modal" 
                                data-bs-target="#chartModal"
                                style="width: 250px; height:auto; cursor:zoom-in;">
                        </td>
                        <td class="text-end">
                            <img id="chart78-${index}" 
                                src="data:image/png;base64,${item.chart78}" 
                                alt="Chart" 
                                class="chart-img"
                                data-bs-toggle="modal" 
                                data-bs-target="#chartModal"
                                style="width: 250px; height:auto; cursor:zoom-in;">
                        </td>
                        <td class="text-end">
                            <img id="chart79-${index}" 
                                src="data:image/png;base64,${item.chart79}" 
                                alt="Chart" 
                                class="chart-img"
                                data-bs-toggle="modal" 
                                data-bs-target="#chartModal"
                                style="width: 250px; height:auto; cursor:zoom-in;">
                        </td>
                        <td>
                            <a href="/stock_analyze2/${encodeURIComponent(item.ticker)}" class="ticker-link">
                                ${item.ticker || '-'}
                            </a>
                        </td>
                        <td class="text-end">${item.latest_close || '-'}</td>
                        <td class="text-end">${previousClose}</td>
                        <td class="text-end">${priceChangeAbs}</td>
                        <td class="text-end">${priceChangePercent}</td>
                        <td class="text-end">${priceZone}</td>
                        <td class="text-end">${item.trendHighPrice_analysis}</td>
                        <td class="text-end">${volumeSignal}</td>
                        <td class="text-end">${item.analysis}</td>
                        <td class="text-end">${item.candle_pattern || '-'}</td>
                        <td class="text-end">${item.signal}</td>
                        <td class="text-end">${item.rsi_status}</td>
                        <td class="text-end">${item.rsi_signal}</td>
                        <td>-</td> <!-- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° created_at -->
                        <td class="text-center">
                            <button class="btn btn-sm btn-danger delete-watchlist" data-ticker="${item.ticker}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                displayWatchlistSet100List(data.all_results);

        } catch (error) {
            console.error("Error loading watchlist:", error);
        } finally {
            showLoading(false, 'Watchlist');
        }

        document.querySelectorAll('.delete-watchlist').forEach(btn => {
            btn.addEventListener('click', async function () {
                const ticker = this.getAttribute('data-ticker');
                const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${ticker} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Watchlist ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
                if (confirmed) {
                    await deleteFromWatchList(ticker);
                    loadWatchlist(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö
                }
            });
        });
    }

    async function deleteAllWatchList() {
        try {
            const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Watchlist ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
            if (confirmed) {
                await deleteFromWatchList('all');
                loadWatchlist(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö
            }
        } catch (error) {
            console.error("Error deleting watchlist:", error);
        }
    }

    async function deleteFromWatchList(ticker) {
        try {
            const response = await fetch(`/watchlist/${ticker}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (!response.ok) {
                alert(`‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.error}`);
            }
        } catch (error) {
            console.error("Error deleting watchlist item:", error);
        }
    }

    async function analyze() {
      const symbol = document.getElementById("inputText").value.trim();
      document.getElementById("chart").src = "";
      showResult('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', 'success');

      const res = await fetch("/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ symbol })
      });

      const data = await res.json();

      if (res.ok) {
        showResult("üìä " + data.summary, 'success');
        //document.getElementById("summary").textContent = "üìä " + data.summary;
        document.getElementById("chart").src = "data:image/png;base64," + data.chart;
        document.getElementById("chart2").src = "data:image/png;base64," + data.chart2;
        document.getElementById("chart3").src = "data:image/png;base64," + data.chart3;
        document.getElementById("chart4").src = "data:image/png;base64," + data.chart4;
        document.getElementById("chart5").src = "data:image/png;base64," + data.chart5;
        document.getElementById("chart6").src = "data:image/png;base64," + data.chart6;
        document.getElementById("chart7").src = "data:image/png;base64," + data.chart7;

    } else {
        showResult("‚ùå " + data.error, 'danger');
        //document.getElementById("summary").textContent = "‚ùå " + data.error;
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const chartModal = document.getElementById('chartModal');
        const modalImage = document.getElementById('modalImage');
        const modalTitle = document.getElementById('chartModalLabel');
        const downloadBtn = document.getElementById('downloadBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const helpText = document.getElementById('helpText');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetZoomBtn = document.getElementById('resetZoomBtn');
        
        let scale = 1;
        let posX = 0;
        let posY = 0;
        let isDragging = false;
        let startX, startY;
        let currentModal = null;
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡∏•‡∏ö backdrop
        function closeModal() {
            if (currentModal) {
                currentModal.hide();
            }
            
            // ‡∏•‡∏ö modal backdrop ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                backdrop.parentNode.removeChild(backdrop);
            });
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï style ‡∏Ç‡∏≠‡∏á body ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ
            document.body.classList.remove('modal-open');
            document.body.style.overflow = 'auto';
            document.body.style.paddingRight = '0';
            document.body.style.position = 'static';
        }
        
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ modal ‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á
        chartModal.addEventListener('show.bs.modal', function (event) {
            const clickedChart = event.relatedTarget;
            modalImage.src = clickedChart.src;
            modalTitle.textContent = clickedChart.alt;
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            scale = 1;
            posX = 0;
            posY = 0;
            applyTransform();
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            downloadBtn.onclick = function() {
                const link = document.createElement('a');
                link.href = clickedChart.src;
                link.download = clickedChart.alt + '.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            // ‡πÄ‡∏Å‡πá‡∏ö reference ‡πÑ‡∏õ‡∏¢‡∏±‡∏á modal instance
            currentModal = new bootstrap.Modal(chartModal);
        });
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        function applyTransform() {
            const container = modalImage.parentElement;
            const containerRect = container.getBoundingClientRect();
            const imageRect = modalImage.getBoundingClientRect();
            
            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
            const maxX = Math.max(0, (imageRect.width * scale - containerRect.width) / 2);
            const maxY = Math.max(0, (imageRect.height * scale - containerRect.height) / 2);
            
            posX = Math.min(maxX, Math.max(-maxX, posX));
            posY = Math.min(maxY, Math.max(-maxY, posY));
            
            modalImage.style.transformOrigin = 'center center';
            modalImage.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
            modalImage.style.cursor = scale > 1 ? 'grab' : 'default';
        }
        
        // ‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡∏î‡πâ‡∏ß‡∏¢ Scroll ‡πÄ‡∏°‡∏≤‡∏™‡πå - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        modalImage.addEventListener('wheel', function(e) {
            e.preventDefault();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ Scroll
            //helpText.style.display = 'block';
            setTimeout(() => {
                helpText.style.display = 'none';
            }, 3000);
            
            const rect = modalImage.getBoundingClientRect();
            const containerRect = modalImage.parentElement.getBoundingClientRect();
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö container
            const offsetX = e.clientX - containerRect.left;
            const offsetY = e.clientY - containerRect.top;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏û (‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡∏π‡∏°)
            const imageX = (offsetX - posX) / scale;
            const imageY = (offsetY - posY) / scale;
            
            const delta = e.deltaY > 0 ? -0.2 : 0.2;
            const newScale = Math.max(0.5, Math.min(5, scale + delta));
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
            posX = offsetX - imageX * newScale;
            posY = offsetY - imageY * newScale;
            
            scale = newScale;
            applyTransform();
        });
        
        // ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
        modalImage.addEventListener('mousedown', function(e) {
            if (scale > 1) {
                isDragging = true;
                startX = e.clientX - posX;
                startY = e.clientY - posY;
                modalImage.style.cursor = 'grabbing';
            }
        });
        
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                posX = e.clientX - startX;
                posY = e.clientY - startY;
                applyTransform();
            }
        });
        
        document.addEventListener('mouseup', function() {
            isDragging = false;
            modalImage.style.cursor = scale > 1 ? 'grab' : 'default';
        });
        
        // ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        modalImage.addEventListener('dblclick', function() {
            scale = 1;
            posX = 0;
            posY = 0;
            applyTransform();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            helpText.textContent = '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡πÅ‡∏•‡πâ‡∏ß';
            helpText.style.display = 'block';
            setTimeout(() => {
                helpText.style.display = 'none';
                //helpText.textContent = '‡πÉ‡∏ä‡πâ Scroll ‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å ‚Ä¢ ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï';
            }, 2000);
        });
        
        // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏π–º
        zoomInBtn.addEventListener('click', function() {
            const containerRect = modalImage.parentElement.getBoundingClientRect();
            const centerX = containerRect.width / 2;
            const centerY = containerRect.height / 2;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏û
            const imageX = (centerX - posX) / scale;
            const imageY = (centerY - posY) / scale;
            
            const newScale = Math.min(5, scale + 0.5);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
            posX = centerX - imageX * newScale;
            posY = centerY - imageY * newScale;
            
            scale = newScale;
            applyTransform();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            //helpText.style.display = 'block';
            setTimeout(() => {
                helpText.style.display = 'none';
            }, 2000);
        });
        
        zoomOutBtn.addEventListener('click', function() {
            const containerRect = modalImage.parentElement.getBoundingClientRect();
            const centerX = containerRect.width / 2;
            const centerY = containerRect.height / 2;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏û
            const imageX = (centerX - posX) / scale;
            const imageY = (centerY - posY) / scale;
            
            const newScale = Math.max(0.5, scale - 0.5);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
            posX = centerX - imageX * newScale;
            posY = centerY - imageY * newScale;
            
            scale = newScale;
            applyTransform();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            //helpText.style.display = 'block';
            setTimeout(() => {
                helpText.style.display = 'none';
            }, 2000);
        });
        
        resetZoomBtn.addEventListener('click', function() {
            scale = 1;
            posX = 0;
            posY = 0;
            applyTransform();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            helpText.textContent = '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡πÅ‡∏•‡πâ‡∏ß';
            helpText.style.display = 'block';
            setTimeout(() => {
                helpText.style.display = 'none';
                //helpText.textContent = '‡πÉ‡∏ä‡πâ Scroll ‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å ‚Ä¢ ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï';
            }, 2000);
        });
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î modal
        closeModalBtn.addEventListener('click', function() {
            closeModal();
        });
                
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏≠‡∏≠‡∏Å
        modalImage.addEventListener('mouseleave', function() {
            helpText.style.display = 'none';
        });
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏†‡∏≤‡∏û
        modalImage.addEventListener('mouseenter', function() {
            if (scale > 1) {
                //helpText.style.display = 'block';
                setTimeout(() => {
                    helpText.style.display = 'none';
                }, 3000);
            }
        });
        
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ modal ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
        chartModal.addEventListener('hidden.bs.modal', function () {
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ modal ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
            scale = 1;
            posX = 0;
            posY = 0;
            isDragging = false;
            currentModal = null;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏ö backdrop ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà
            setTimeout(() => {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                if (backdrops.length > 0) {
                    backdrops.forEach(backdrop => {
                        backdrop.parentNode.removeChild(backdrop);
                    });
                }
                
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï style ‡∏Ç‡∏≠‡∏á body ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ
                document.body.classList.remove('modal-open');
                document.body.style.overflow = 'auto';
                document.body.style.paddingRight = '0';
                document.body.style.position = 'static';
            }, 100);
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÉ‡∏ô header
        document.querySelector('.modal-header .btn-close').addEventListener('click', function() {
            closeModal();
        });
    });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom/dist/panzoom.min.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script type="text/javascript">
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('th-TH');
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö widget
        let tvWidget = null;
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü
        function initializeChart(symbol) {
            if (tvWidget !== null) {
                tvWidget.remove();
            }
            
            tvWidget = new TradingView.widget({
                "width": "1000",
                "height": "500",
                "symbol": symbol,
                "interval": "W",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "withdateranges": true,
                "hide_side_toolbar": false,
                "allow_symbol_change": true,
                "container_id": "tradingview_chart"
            });
        }
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ AAPL
        initializeChart("NASDAQ:AAPL");
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ stock item
        document.querySelectorAll('.stock-item').forEach(item => {
            item.addEventListener('click', function() {
                // ‡∏•‡∏ö class active ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                document.querySelectorAll('.stock-item').forEach(el => {
                    el.classList.remove('active');
                });
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° class active ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö element ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
                this.classList.add('active');
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ symbol ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const symbol = this.getAttribute('data-symbol');
                initializeChart(symbol);
            });
        });
    </script>
</body>
</html>
