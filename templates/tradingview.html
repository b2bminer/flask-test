<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SET Stock Chart (TradingView Style)</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles_tradingview.css') }}">
</head>
<body>
    <div id="app-wrapper">
        <header class="chart-header">
            
            <div class="chart-controls">
                <!-- ‡∏™‡πà‡∏ß‡∏ô Input ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° Load -->
                <div class="control-section">
                    <input type="text" id="symbol" placeholder="Symbol" value="PTT.BK">
                    <button onclick="loadChart()">Load</button>
                </div>
                
                <div id="ema-controls" style="position: absolute; top: 60px; left: 0px; padding: 2px; border: 1px solid #ddd; z-index: 100; display: flex; align-items: center; gap: 5px;">
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• EMA -->
                    <div id="ema-info" style="display: flex; gap: 5px;">
                        <div style="color: #1E90FF; min-width: 100px;"><b>EMA 5</b>: <span id="ema5-value">-</span></div>
                        <div style="color: #FF8C00; min-width: 100px;"><b>EMA 20</b>: <span id="ema20-value">-</span></div>
                        <div style="color: #ffffff; min-width: 60px;"><b>O</b>: <span id="open-value">-</span></div>
                        <div style="color: #ffffff; min-width: 60px;"><b>H</b>: <span id="high-value">-</span></div>
                        <div style="color: #ffffff; min-width: 60px;"><b>L</b>: <span id="low-value">-</span></div>
                        <div style="color: #ffffff; min-width: 60px;"><b>C</b>: <span id="close-value">-</span></div>
                        <div style="color: #f2eb18; min-width: 100px;"><b>V</b>: <span id="volume-value">-</span></div>
                        <div style="color: #f2eb18; min-width: 100px;"><b>VA</b>: <span id="volume-ma-value">-</span></div>
                    </div>        
                    <!-- ‡∏õ‡∏∏‡πà‡∏° Toggle EMA -->
                    <button id="toggle-ema-btn" onclick="toggleEMA()" style="padding: 2px 2px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                        Hide
                    </button>
                </div>
            </div>

            <div class="control-group">            
                <!-- ‡∏õ‡∏∏‡πà‡∏° Timeframe -->
                <div class="control-section timeframe-controls">
                    <button class="timeframe-btn" onclick="changeTimeframe('15m')">15m</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('1h')">1h</button>
                    <button class="timeframe-btn active" onclick="changeTimeframe('1D')">1D</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('1W')">1W</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('1M')">1M</button>
                </div>
                
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏£‡∏≤‡∏ü -->
                <div class="control-section">
                    <button class="control-btn active" id="zoom-btn" title="Zoom Mode">Zoom</button>
                    <button class="control-btn" id="pan-btn" title="Pan Mode">Pan</button>
                    <button class="control-btn" onclick="resetChart()" title="Reset">Reset</button>
                    <button id="fullscreen-btn" title="Toggle Fullscreen" style="padding: 5px 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-expand"></i> Fullscreen
                    </button>
                </div>
            </div>
            <div class="theme-controls">
                <button id="light-theme-btn" class="theme-btn active">Light</button>
                <button id="dark-theme-btn" class="theme-btn">Dark</button>
            </div>
        </header>
        <div id="chart-container" style="display: flex; flex-direction: column; height: 100%; gap: 0;">
            <div id="chart" style="flex: 1; min-height: 300px;"></div>
            <div id="volume-chart" style="flex: 1; min-height: 100px;"></div>
                    <div id="drag-overlay"></div>
        </div>

    </div>

    <script>

    const container = document.getElementById('chart-container');
    
    const width = container.clientWidth;
    const height = Math.max(300, container.clientHeight * 0.7); // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 300px
    
        //const width = document.getElementById("chart").clientWidth;

        const chart = LightweightCharts.createChart(document.getElementById("chart"), {
            width: width,
            height: height,
            layout: {
                background: { color: '#FFFFFF' },
                textColor: '#D9D9D9',
            },
            grid: {
                vertLines: { color: '#eee' },
                horzLines: { color: '#eee' },
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
                borderColor: '#cccccc',
            },
            handleScroll: {
                mouseWheel: true,
                pressedMouseMove: true,
            },
            handleScale: {
                axisPressedMouseMove: true,
                mouseWheel: true,
                pinch: true,
            }
        });

        const candleSeries = chart.addCandlestickSeries({
            upColor: '#00C805',
            downColor: '#FF0000',
            borderUpColor: '#00C805',
            borderDownColor: '#FF0000',
            wickUpColor: '#003300',
            wickDownColor: '#660000',
            borderVisible: true,
            thinBars: false,
        });
        candleSeries.applyOptions({
            borderUpColor: '#00C805',
            borderDownColor: '#FF0000',
            borderVisible: true,
            borderWidth: 2,
        });

        // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏¢‡∏°‡πÉ‡∏ä‡πâ
        const blueColors = {
            dodgerBlue: '#1E90FF',
            royalBlue: '#4169E1',
            steelBlue: '#4682B4',
            deepSkyBlue: '#00BFFF',
            cornflowerBlue: '#6495ED',
            mediumBlue: '#0000CD',
            darkBlue: '#00008B'
        };
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á series ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö EMA
        const ema5Series = chart.addLineSeries({
            color: blueColors.darkBlue, // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
            lineWidth: 1,
            //title: 'EMA 5',
            crosshairMarkerVisible: false,
            crosshairMarkerRadius: 4,
            crosshairMarkerBorderColor: '#1E90FF',
            crosshairMarkerBackgroundColor: '#FFFFFF',
            priceLineVisible: false, // ‡∏õ‡∏¥‡∏î price line ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏Å‡∏£‡∏≤‡∏ü (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
            lastValueVisible: false
        });

        const ema20Series = chart.addLineSeries({
            color: '#FF8C00', // ‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏°
            lineWidth: 1,
            //title: 'EMA 20',
            crosshairMarkerVisible: false,
            priceLineVisible: false, // ‡∏õ‡∏¥‡∏î price line ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏Å‡∏£‡∏≤‡∏ü (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
            lastValueVisible: false
        });

        const volumeChart = LightweightCharts.createChart(document.getElementById('volume-chart'), {
            width: width,
            height: Math.max(100, container.clientHeight * 0.3), // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100px
            timeScale: {
            visible: false,
            borderVisible: false,
            },
            //crossHair: { mode: LightweightCharts.CrossHairMode.Normal },
            layout: { backgroundColor: '#fff', textColor: '#000', fontSize: 9 },
        });
        const volumeSeries = volumeChart.addHistogramSeries({
            color: '#26a69a',
            priceFormat: { type: 'volume' },
            lastValueVisible: false, // üëà ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏ö‡∏≤‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏Å‡∏ô‡∏Ç‡∏ß‡∏≤
            //priceScaleId: '',
            scaleMargins: { top: 0.1, bottom: 0 },
        });
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì
        const volumeMASeries = volumeChart.addLineSeries({
            color: '#FFA500', // ‡∏™‡∏µ‡∏™‡πâ‡∏°
            lineWidth: 1,
            title: '',
            crosshairMarkerVisible: false,
            lastValueVisible: false, // üëà ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏ö‡∏≤‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏Å‡∏ô‡∏Ç‡∏ß‡∏≤
            //priceScaleId: '',
            scaleMargins: { top: 0.1, bottom: 0 },
        });

        let currentTimeframe = '1D';
        let currentSymbol = 'PTT.BK';
        let currentVisibleRange = null;

        loadChart();

        function loadChart() {
            currentSymbol = document.getElementById("symbol").value;
            updateTimeframeButtons();
            loadData(currentTimeframe);
        }

        function changeTimeframe(tf) {
            currentTimeframe = tf;
            updateTimeframeButtons();
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å timeframe ‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏õ‡πÄ‡∏•‡πá‡∏Å ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏¢‡∏π‡πà
            if (isLargerToSmallerTimeframe(currentTimeframe, tf)) {
                const range = chart.timeScale().getVisibleRange();
                loadData(tf, range.from, range.to);
            } else {
                loadData(tf);
            }
        }

        function isLargerToSmallerTimeframe(oldTf, newTf) {
            const tfOrder = ['1mo', '1wk', '1d', '15m'];
            return tfOrder.indexOf(oldTf) < tfOrder.indexOf(newTf);
        }

        function updateTimeframeButtons() {
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === currentTimeframe.toLowerCase()) {
                    btn.classList.add('active');
                }
            });
        }


        let data = [];
        let volumeWithMA = [];
        let ema5Data,ema20Data = [];

        function loadData(tf, from = null, to = null) {
            let url = `/tradingviewdata?symbol=${currentSymbol}&timeframe=${tf}`;
            if (from && to) {
                url += `&from=${from}&to=${to}`;
            }

            fetch(url)
                .then(res => res.json())
                .then(response  => {
                    currentTimeframe = tf;
                    data = response;
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• EMA
                    ema5Data = data.map(item => ({
                        time: item.time,
                        value: item.ema5
                    }));
                    
                    ema20Data = data.map(item => ({
                        time: item.time,
                        value: item.ema20
                    }));

                    const volumeData = data.map(item => ({
                    //time: new Date(item.time).getTime() / 1000,
                    time: item.time,  // <<< ‡πÉ‡∏ä‡πâ time ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö candle
                    value: item.volume,
                    color: item.close > item.open ? '#00FF00' : '#FF0000',
                    }));

                    volumeWithMA = calculateVolumeMA(data, 20);
                    volumeMASeries.setData(volumeWithMA.map(item => ({
                        time: item.time,
                        value: item.volumeMA
                    })));

                    candleSeries.setData(data);
                    volumeSeries.setData(volumeData);
                    ema5Series.setData(ema5Data);
                    ema20Series.setData(ema20Data);
                    chart.timeScale().fitContent();
                    volumeChart.timeScale().fitContent();

                    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° TimeScale ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                    chart.timeScale().subscribeVisibleTimeRangeChange(timeRange => {
                        volumeChart.timeScale().setVisibleRange(timeRange);
                    });

                    volumeChart.timeScale().subscribeVisibleTimeRangeChange(timeRange => {
                        chart.timeScale().setVisibleRange(timeRange);
                    });

                });
        }


        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì
        function calculateVolumeMA(data, period) {
        return data.map((item, index) => {
            if (index >= period - 1) {
            const sum = data
                .slice(index - period + 1, index + 1)
                .reduce((acc, val) => acc + val.volume, 0);
            return {
                ...item,
                volumeMA: sum / period
            };
            }
            return {
            ...item,
            volumeMA: null
            };
        }).filter(item => item.volumeMA !== null);
        }

        function updateInfo(time) {
            const bar = data.find(d => d.time === time);
            const ema5 = ema5Data.find(d => d.time === time);
            const ema20 = ema20Data.find(d => d.time === time);
            const ma = volumeWithMA.find(d => d.time === time);
            if (!bar) return;
            document.getElementById('open-value').textContent = bar.open.toFixed(2);
            document.getElementById('high-value').textContent = bar.high.toFixed(2);
            document.getElementById('low-value').textContent = bar.low.toFixed(2);
            document.getElementById('close-value').textContent = bar.close.toFixed(2);
            document.getElementById('volume-value').textContent = bar.volume.toLocaleString();
            document.getElementById('volume-ma-value').textContent = ma ? ma.volumeMA.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '-';
            document.getElementById('ema5-value').textContent = ema5 ? ema5.value.toFixed(2) : '-';
            document.getElementById('ema20-value').textContent = ema20 ? ema20.value.toFixed(2) : '-';
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Legend ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà
        chart.subscribeCrosshairMove(param => {
            if (param.time && param.point) {
                updateInfo(param.time);
                volumeChart.setCrosshairPosition(param.point.x, 0);
            }
        });

        volumeChart.subscribeCrosshairMove(param => {
            if (param.time && param.point) {
                updateInfo(param.time);
                chart.setCrosshairPosition(param.point.x, 0);
            }
        });



        let emaVisible = true;

        function toggleEMA() {
            emaVisible = !emaVisible;
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô EMA
            ema5Series.applyOptions({ visible: emaVisible });
            ema20Series.applyOptions({ visible: emaVisible });
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°
            document.getElementById('toggle-ema-btn').textContent = emaVisible ? 'Hide' : 'Show';
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Legend
            document.getElementById('ema-info').style.display = emaVisible ? 'flex' : 'none';
        }

        // ‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå
        const chartDiv = document.getElementById("chart");
        const overlay = document.getElementById("drag-overlay");
        let isDragging = false;
        let dragStartX = 0;

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏°‡∏î
        let currentMode = 'zoom'; // 'zoom' ‡∏´‡∏£‡∏∑‡∏≠ 'pan'

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${mode}-btn`).classList.add('active');
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
            chart.applyOptions({
                handleScroll: {
                    mouseWheel: true,
                    pressedMouseMove: mode === 'pan',
                },
                handleScale: {
                    axisPressedMouseMove: mode === 'zoom',
                        mouseWheel: true,
                        pinch: true,
                    }
                });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
        function resetChart() {
            chart.timeScale().fitContent();
            volumeChart.timeScale().fitContent();
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏´‡∏°‡∏î
        setMode('zoom');

        // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå
        chartDiv.addEventListener("mousedown", (e) => {
            if (currentMode !== 'zoom') return;
            isDragging = true;
            dragStartX = e.offsetX;
            overlay.style.left = `${dragStartX}px`;
            overlay.style.width = `0px`;
            overlay.style.display = "block";
        });

        chartDiv.addEventListener("mousemove", (e) => {
            if (!isDragging) return;
            const currentX = e.offsetX;
            const left = Math.min(dragStartX, currentX);
            const width = Math.abs(currentX - dragStartX);
            overlay.style.left = `${left}px`;
            overlay.style.width = `${width}px`;
        });

        chartDiv.addEventListener("mouseup", (e) => {
            if (!isDragging || currentMode !== 'zoom') return;
            isDragging = false;
            overlay.style.display = "none";

            const dragEndX = e.offsetX;
            if (Math.abs(dragEndX - dragStartX) < 10) return;

            const fromTime = chart.timeScale().coordinateToTime(Math.min(dragStartX, dragEndX));
            const toTime = chart.timeScale().coordinateToTime(Math.max(dragStartX, dragEndX));
            
            chart.timeScale().setVisibleRange({ from: fromTime, to: toTime });
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
        document.getElementById("zoom-btn").addEventListener("click", () => setMode('zoom'));
        document.getElementById("pan-btn").addEventListener("click", () => setMode('pan'));


        function setTheme(isDark) {
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            document.body.className = isDark ? 'dark-theme' : 'light-theme';
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const chartOptions = {
            layout: {
                background: { color: isDark ? '#121212' : '#FFFFFF' },
                textColor: isDark ? '#D9D9D9' : '#333333',
            },
                grid: {
                    vertLines: { 
                        color: isDark ? '#2B2B43' : '#EEEEEE',
                        visible: true
                    },
                    horzLines: { 
                        color: isDark ? '#2B2B43' : '#EEEEEE',
                        visible: true
                    }
                },
                crosshair: {
                    vertLine: {
                        color: isDark ? '#D9D9D9' : '#333333',
                        labelBackgroundColor: isDark ? '#1E222D' : '#FFFFFF'
                    },
                    horzLine: {
                        color: isDark ? '#D9D9D9' : '#333333',
                        labelBackgroundColor: isDark ? '#1E222D' : '#FFFFFF'
                    }
                },
                rightPriceScale: {
                    borderColor: isDark ? '#2B2B43' : '#EEEEEE'
                },
                timeScale: {
                    borderColor: isDark ? '#2B2B43' : '#EEEEEE'
                }
            };
            
            // ‡πÉ‡∏ä‡πâ applyOptions ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            chart.applyOptions(chartOptions);
            volumeChart.applyOptions(chartOptions);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô EMA
            ema5Series.applyOptions({
                color: isDark ? '#1E90FF' : '#2962FF',
                priceLineColor: isDark ? 'rgba(30, 144, 255, 0.3)' : 'rgba(41, 98, 255, 0.3)'
            });
            
            ema20Series.applyOptions({
                color: isDark ? '#FF8C00' : '#FF6D00',
                priceLineColor: isDark ? 'rgba(255, 140, 0, 0.3)' : 'rgba(255, 109, 0, 0.3)'
            });
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏µ‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô
            candleSeries.applyOptions({
                upColor: isDark ? '#00FF00' : '#089981',
                downColor: isDark ? '#FF0000' : '#f23645',
                borderUpColor: isDark ? '#00FF00' : '#089981',
                borderDownColor: isDark ? '#FF0000' : '#f23645',
                wickUpColor: isDark ? '#00FF00' : '#089981',
                wickDownColor: isDark ? '#FF0000' : '#f23645',
                borderVisible: true
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô ema-controls
            const emaInfo = document.getElementById('ema-info');
            if (emaInfo) {
                const textColor = isDark ? '#FFFFFF' : '#000000';  // ‡∏™‡∏µ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å
                const yellowColor = isDark ? '#f2eb18' : '#ccaa00'; // ‡∏™‡∏µ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (V, VA)

                emaInfo.querySelector('#open-value').parentElement.style.color = textColor;
                emaInfo.querySelector('#high-value').parentElement.style.color = textColor;
                emaInfo.querySelector('#low-value').parentElement.style.color = textColor;
                emaInfo.querySelector('#close-value').parentElement.style.color = textColor;

                emaInfo.querySelector('#volume-value').parentElement.style.color = yellowColor;
                emaInfo.querySelector('#volume-ma-value').parentElement.style.color = yellowColor;
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
            document.getElementById('light-theme-btn').classList.toggle('active', !isDark);
            document.getElementById('dark-theme-btn').classList.toggle('active', isDark);
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            localStorage.setItem('chartTheme', isDark ? 'dark' : 'light');
            
            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏°‡∏µ‡∏ú‡∏•
            chart.timeScale().fitContent();
            volumeChart.timeScale().fitContent();

        }

        // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏ò‡∏µ‡∏°‡∏à‡∏≤‡∏Å localStorage ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        const savedTheme = localStorage.getItem('chartTheme') || 'light';
        setTheme(savedTheme === 'dark');


        // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
        document.getElementById('light-theme-btn').addEventListener('click', () => setTheme(false));
        document.getElementById('dark-theme-btn').addEventListener('click', () => setTheme(true));
        //setTheme(isDarkMode);

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ time scale ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
        const commonTimeScaleOptions = {
          rightOffset: 0.5,
          barSpacing: 0.5,
          fixLeftEdge: false,
          fixRightEdge: false,
          lockVisibleTimeRangeOnResize: true,
          rightBarStaysOnScroll: true,
          borderVisible: true,
          borderColor: '#ccc',
          visible: true,
          timeVisible: true,
          secondsVisible: false
        };

        chart.applyOptions({
          timeScale: commonTimeScaleOptions
        });

        volumeChart.applyOptions({
          timeScale: {
            ...commonTimeScaleOptions,
            visible: false // ‡∏ã‡πà‡∏≠‡∏ô time scale ‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì
          }
        });

        function syncScroll(masterChart, slaveChart) {
            let isSyncing = false;

            masterChart.timeScale().subscribeVisibleLogicalRangeChange((range) => {
                if (isSyncing || range === null) return;
                isSyncing = true;
                slaveChart.timeScale().setVisibleLogicalRange(range);
                isSyncing = false;
            });
        }
        syncScroll(chart, volumeChart);
        syncScroll(volumeChart, chart);


function toggleFullscreen() {
    const appWrapper = document.getElementById('app-wrapper');
    
    if (!document.fullscreenElement) {
        if (appWrapper.requestFullscreen) {
            appWrapper.requestFullscreen();
        } else if (appWrapper.webkitRequestFullscreen) {
            appWrapper.webkitRequestFullscreen();
        } else if (appWrapper.msRequestFullscreen) {
            appWrapper.msRequestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }
}

function resizeCharts() {
    const container = document.getElementById('chart-container');
    if (!container) return;

    const width = container.clientWidth;
    const containerHeight = container.clientHeight;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isFullscreen = !!document.fullscreenElement;
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (80% ‡∏£‡∏≤‡∏Ñ‡∏≤, 20% ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì)
    const priceHeight = isFullscreen 
        ? Math.floor(containerHeight * 0.74)
        : Math.min(400, Math.floor(containerHeight * 0.7));
    
    const volumeHeight = isFullscreen
        ? Math.floor(containerHeight * 0.2)
        : Math.min(150, Math.floor(containerHeight * 0.3));
    
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
    chart.resize(width, priceHeight);
    volumeChart.resize(width, volumeHeight);
    
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á EMA Controls
    adjustEMAControlsPosition();
}

function adjustEMAControlsPosition() {
    const emaControls = document.getElementById('ema-controls');
    if (!emaControls) return;
    
    if (document.fullscreenElement) {
        emaControls.style.top = '70px';
        emaControls.style.left = '20px';
    } else {
        emaControls.style.top = '50px';
        emaControls.style.left = '10px';
    }
}

function updateFullscreenButton() {
    const btn = document.getElementById('fullscreen-btn');
    if (!btn) return;
    
    btn.innerHTML = document.fullscreenElement 
        ? '<i class="fas fa-compress"></i> Exit Fullscreen' 
        : '<i class="fas fa-expand"></i> Fullscreen';
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(resizeCharts, 100); // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
});

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
window.addEventListener('resize', () => {
    clearTimeout(window.resizeTimer);
    window.resizeTimer = setTimeout(resizeCharts, 200);
});

// ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('msfullscreenchange', handleFullscreenChange);

document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);

function handleFullscreenChange() {
    resizeCharts();
    updateFullscreenButton();
    
}


</script>
</body>
</html>
